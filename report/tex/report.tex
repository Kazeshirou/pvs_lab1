\documentclass[a4paper,12pt]{article}

\input{header.tex}

\title{Отчёт по лабораторной работе \\ <<IP-маршрутизация>>}
\author{Жарова~Н.~А.}

\begin{document}

\maketitle

\tableofcontents

% Текст отчёта должен быть читаемым!!! Написанное здесь является рыбой.

\section{Топология сети}

Топология сети и использыемые IP-адреса показаны на рис.~\ref{fig:network}.

\begin{figure}
\centering
\includegraphics[width=\textwidth]{includes/network_gv.pdf}
\caption{Топология сети}
\label{fig:network}
\end{figure}


\section{Назначение IP-адресов}

Ниже приведён файл настройки протокола IP маршрутизатора \textbf{r1}.

\begin{Verbatim}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.0.10.1
netmask 255.255.255.0
up ip r add 10.0.20.0/24 via 10.0.10.2 dev eth0; ip r add 10.0.30.0/24 via 10.0.10.2 dev eth0
down ip r del 10.0.20.0/24; ip r del 10.0.30.0/24

auto eth1
iface eth1 inet static
address 10.0.40.1
netmask 255.255.255.0
up ip r add 10.0.50.0/24 via 10.0.40.2 dev eth1
down ip r del 10.0.50.0/24
\end{Verbatim}

Ниже приведён файл настройки протокола IP маршрутизатора \textbf{r2}.

\begin{Verbatim}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.0.10.2
netmask 255.255.255.0
up ip r add 10.0.40.0/24 via 10.0.10.1 dev eth0
down ip r del 10.0.40.0/24

auto eth1
iface eth1 inet static
address 10.0.30.1
netmask 255.255.255.0
up ip r add 10.0.50.0/24 via 10.0.30.2 dev eth1
down ip r del 10.0.50.0/24

auto eth2
iface eth2 inet static
address 10.0.20.1
netmask 255.255.255.0
\end{Verbatim}

Ниже приведён файл настройки протокола IP маршрутизатора \textbf{r3}.

\begin{Verbatim}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.0.30.2
netmask 255.255.255.0
up ip r add 10.0.20.0/24 via 10.0.30.1 dev eth0
down ip r del 10.0.20.0/24

auto eth1
iface eth1 inet static
address 10.0.40.2
netmask 255.255.255.0
up ip r add 10.0.10.0/24 via 10.0.40.1 dev eth1
down ip r del 10.0.10.0/24

auto eth2
iface eth2 inet static
address 10.0.50.1
netmask 255.255.255.0
\end{Verbatim}

Ниже приведён файл настройки протокола IP рабочей станции \textbf{ws1}.

\begin{Verbatim}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.0.20.2
netmask 255.255.255.0
gateway 10.0.20.1
\end{Verbatim}

Ниже приведён файл настройки протокола IP рабочей станции \textbf{ws2}.

\begin{Verbatim}
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 10.0.50.2
netmask 255.255.255.0
gateway 10.0.50.1
\end{Verbatim}

\section{Таблица маршрутизации}

Вывод (\textit{ip r}) таблицы маршрутизации для \textbf{r1}.

\begin{Verbatim}
10.0.20.0/24 via 10.0.10.2 dev eth0 
10.0.50.0/24 via 10.0.40.2 dev eth1 
10.0.30.0/24 via 10.0.10.2 dev eth0 
10.0.40.0/24 dev eth1  proto kernel  scope link  src 10.0.40.1 
10.0.10.0/24 dev eth0  proto kernel  scope link  src 10.0.10.1 
\end{Verbatim}


Вывод (\textit{ip r}) таблицы маршрутизации для \textbf{r2}.

\begin{Verbatim}
10.0.20.0/24 dev eth2  proto kernel  scope link  src 10.0.20.1 
10.0.50.0/24 via 10.0.30.2 dev eth1 
10.0.30.0/24 dev eth1  proto kernel  scope link  src 10.0.30.1 
10.0.40.0/24 via 10.0.10.1 dev eth0 
10.0.10.0/24 dev eth0  proto kernel  scope link  src 10.0.10.2
\end{Verbatim}

Вывод (\textit{ip r}) таблицы маршрутизации для \textbf{r3}.

\begin{Verbatim}
10.0.20.0/24 via 10.0.30.1 dev eth0 
10.0.50.0/24 dev eth2  proto kernel  scope link  src 10.0.50.1 
10.0.30.0/24 dev eth0  proto kernel  scope link  src 10.0.30.2 
10.0.40.0/24 dev eth1  proto kernel  scope link  src 10.0.40.2 
10.0.10.0/24 via 10.0.40.1 dev eth1 
\end{Verbatim}

Вывод (\textit{ip r}) таблицы маршрутизации для \textbf{ws1}.

\begin{Verbatim}
10.0.20.0/24 dev eth0  proto kernel  scope link  src 10.0.20.2 
default via 10.0.20.1 dev eth0 
\end{Verbatim}

Вывод (\textit{ip r}) таблицы маршрутизации для \textbf{ws2}.

\begin{Verbatim}
10.0.50.0/24 dev eth0  proto kernel  scope link  src 10.0.50.2 
default via 10.0.50.1 dev eth0 
\end{Verbatim}

\section{Проверка настройки сети}

Вывод \textbf{traceroute} от узла ws2 до ws1 при нормальной работе сети.

\begin{Verbatim}
traceroute to 10.0.20.2 (10.0.20.2), 64 hops max, 40 byte packets
1  10.0.50.1 (10.0.50.1)  2 ms  1 ms  1 ms
2  10.0.30.1 (10.0.30.1)  5 ms  1 ms  1 ms
3  10.0.20.2 (10.0.20.2)  12 ms  1 ms  1 ms
\end{Verbatim}

Вывод \textbf{traceroute} от узла ws1 до r1 (eth1) при нормальной работе сети.

\begin{Verbatim}
traceroute to 10.0.40.1 (10.0.40.1), 64 hops max, 40 byte packets
1  10.0.20.1 (10.0.20.1)  1 ms  1 ms  0 ms
2  10.0.40.1 (10.0.40.1)  7 ms  1 ms  1 ms
\end{Verbatim}

Вывод \textbf{traceroute} от узла ws2 до r1 (eth0) при нормальной работе сети.

\begin{Verbatim}
traceroute to 10.0.10.1 (10.0.10.1), 64 hops max, 40 byte packets
1  10.0.50.1 (10.0.50.1)  1 ms  1 ms  0 ms
2  10.0.10.1 (10.0.10.1)  11 ms  1 ms  1 ms
\end{Verbatim}


\section{Маршрутизация}

Пример косвенной маршрутизации при передаче пакета \\
от ws1 (eth0 - a6:f9:52:b6:1e:69 - 10.0.20.2/24) 
до r1 (eth0 - 0e:ab:f8:0c:10:4b - 10.0.10.1/24)\\
через r2 (eth2 - 4a:6c:31:ed:d1:db - 10.0.20.1/24 и eth0 - 3a:40:ee:31:9e:cd - 10.0.10.2/24).

Маршрутная таблица маршрутизатора r2 (вывод команды ip r):

\begin{Verbatim}
10.0.20.0/24 dev eth2  proto kernel  scope link  src 10.0.20.1 
10.0.50.0/24 via 10.0.30.2 dev eth1 
10.0.30.0/24 dev eth1  proto kernel  scope link  src 10.0.30.1 
10.0.40.0/24 via 10.0.10.1 dev eth0 
10.0.10.0/24 dev eth0  proto kernel  scope link  src 10.0.10.2 
\end{Verbatim}

Показаны опыты после стирания кеша ARP.

На ws1 будет вызвана команда:
\begin{Verbatim}
ping 10.0.10.1
\end{Verbatim}

Далее показана отправка пакета на маршрутизатор r2 (косвенная маршрутизация). 

\begin{Verbatim}
tcpdump -tne -i eth2

a6:f9:52:b6:1e:69 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), 
     length 42: arp who-has 10.0.20.1 tell 10.0.20.2
4a:6c:31:ed:d1:db > a6:f9:52:b6:1e:69, ethertype ARP (0x0806), 
    length 42: arp reply 10.0.20.1 is-at 4a:6c:31:ed:d1:db
a6:f9:52:b6:1e:69 > 4a:6c:31:ed:d1:db, ethertype IPv4 (0x0800), 
    length 98: 10.0.20.2 > 10.0.10.1: ICMP echo request, id 23554, seq 1, length 64
4a:6c:31:ed:d1:db > a6:f9:52:b6:1e:69, ethertype IPv4 (0x0800), 
    length 98: 10.0.10.1 > 10.0.20.2: ICMP echo reply, id 23554, seq 1, length 64
\end{Verbatim}

Затем маршрутизатор отправил его далее на маршрутизатор r1.

\begin{Verbatim}
tcpdump -tne -i eth0

3a:40:ee:31:9e:cd > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), 
    length 42: arp who-has 10.0.10.1 tell 10.0.10.2
0e:ab:f8:0c:10:4b > 3a:40:ee:31:9e:cd, ethertype ARP (0x0806), 
    length 42: arp reply 10.0.10.1 is-at 0e:ab:f8:0c:10:4b
3a:40:ee:31:9e:cd > 0e:ab:f8:0c:10:4b, ethertype IPv4 (0x0800), 
    length 98: 10.0.20.2 > 10.0.10.1: ICMP echo request, id 23554, seq 1, length 64
0e:ab:f8:0c:10:4b > 3a:40:ee:31:9e:cd, ethertype IPv4 (0x0800), 
    length 98: 10.0.10.1 > 10.0.20.2: ICMP echo reply, id 23554, seq 1, length 64
\end{Verbatim}

\section{Продолжительность жизни пакета}

Сначала написать как и на чём ломали. 

\begin{Verbatim}
Команды ломания
\end{Verbatim}

Потом какая-то таблица вышла.

\begin{Verbatim}
Испорченная таблица маршрутизации
\end{Verbatim}

Потом что слали.

\begin{Verbatim}
Команда посылки
\end{Verbatim}

И что в итоге получилось.

\begin{Verbatim}
Чуть сокращеннный лог, с мак адресами
\end{Verbatim}

И кто в итоге отравил сообщение о завершении жизни.

\section{Изучение IP-фрагментации}

Написать, на каких узлах и как изменяли MTU.


\begin{Verbatim}
Изменение MTU
\end{Verbatim}

\begin{Verbatim}
Изменение MTU
\end{Verbatim}

% Напоминаем, что PMTU следует отключить!

Какие команды давали для тестирования и где.

\begin{Verbatim}
Здесь вписать команду
\end{Verbatim}

Вывод \textbf{tcpdump} на маршрутизаторе перед сетью с уменьшенным MTU.

% Вывод в ширину можно и сократить, удалив несущественные моменты!

\begin{Verbatim}
Здесь вывод tcpdump, мак адреса не нужны.
\end{Verbatim}

Вывод \textbf{tcpdump} на маршрутизаторе после сети с уменьшенным MTU.

% Вывод в ширину можно и сократить, удалив несущественные моменты!

\begin{Verbatim}
Здесь вывод tcpdump, мак адреса не нужны.
\end{Verbatim}


Вывод \textbf{tcpdump} на узле получателя.

\begin{Verbatim}
Здесь вывод tcpdump, мак адреса не нужны.
\end{Verbatim}


\section{Отсутствие сети}

C ws1 была запущена команда:

\begin{Verbatim}
ping 20.0.20.1 -c 1
PING 20.0.20.1 (20.0.20.1) 56(84) bytes of data.
From 10.0.20.1 icmp_seq=1 Destination Net Unreachable
\end{Verbatim}


 На маршрутизаторе r2 запущен перехват трафика:

\begin{Verbatim}
tcpdump -n -i eth2
11:20:56.315890 IP 10.0.20.2 > 20.0.20.1: ICMP echo request, id 19714, seq 1, length 64
11:20:56.315927 IP 10.0.20.1 > 10.0.20.2: ICMP net 20.0.20.1 unreachable, length 92
\end{Verbatim}

Как видно, производится только один ARP-запрос, на который тут же генерируется ICMP-сообщение с информацией о том, что искомая сеть не найдена.

\section{Отсутствие IP-адреса в сети}

C ws1 была запущена команда:

\begin{Verbatim}
ping 10.0.30.3 -c 1
PING 10.0.30.3 (10.0.30.3) 56(84) bytes of data.
From 10.0.20.1 icmp_seq=1 Destination Host Unreachable
\end{Verbatim}


На маршрутизаторе r2 запущен перехват трафика на интерфейсе, подключённом к той же сети, что и ws1:

\begin{Verbatim}
tcpdump -n -i eth2
11:27:53.487495 IP 10.0.20.2 > 10.0.30.3: ICMP echo request, id 20226, seq 1, length 64
11:27:56.493708 IP 10.0.20.1 > 10.0.20.2: ICMP host 10.0.30.3 unreachable, length 92
\end{Verbatim}

 На маршрутизаторе r2 запущен перехват трафика на интерфейсе, подключённом к сети, в котором должен был находится целевой ip-адрес:

\begin{Verbatim}
tcpdump -n -i eth1
11:31:13.746943 arp who-has 10.0.30.3 tell 10.0.30.1
11:31:14.743571 arp who-has 10.0.30.3 tell 10.0.30.1
11:31:15.743563 arp who-has 10.0.30.3 tell 10.0.30.1
\end{Verbatim}

Как видно, производится 3 ARP-запроса с таймаутом в 1 секунду. После того, как на последний запрос в течении секунды не пришёл ответ, 
генерируется ICMP-сообщение с информацией о том, что целевой IP-адрес не найден.

\end{document}
